# OpenSourceMalware Integration

DepGate includes optional integration with the [OpenSourceMalware.com](https://opensourcemalware.com) API for malicious package detection. This integration automatically flags known malicious packages during analysis.

## Overview

The OpenSourceMalware integration:

- Automatically flags malicious packages in heuristics analysis (score = 0.0)
- Supports version-specific checks (critical for accurate detection)
- Integrates with policy rules and MCP output
- Works across all ecosystems (npm, PyPI, Maven, NuGet) and analysis types

## Quick Start

Set the API token via environment variable:

```bash
export DEPGATE_OSM_API_TOKEN=your_token_here
depgate scan -t npm -p package-name -a heur
```

Or use the CLI flag:

```bash
depgate scan -t npm -p package-name -a heur --osm-api-token your_token
```

## Configuration

The integration requires an API token. Provide it via one of these methods (in priority order):

### 1. CLI Argument (Highest Priority)

```bash
depgate scan -t npm -p package-name -a heur --osm-api-token your_token
```

### 2. Environment Variable

```bash
export DEPGATE_OSM_API_TOKEN=your_token
depgate scan -t npm -p package-name -a heur
```

### 3. Command Execution

```bash
depgate scan -t npm -p package-name -a heur \
  --osm-token-command "cat ~/.osm_token"
```

### 4. YAML Configuration

```yaml
opensourcemalware:
  enabled: true
  api_token: "your_token"  # Not recommended - use env var instead
```

**Security Note**: Never commit API tokens in YAML files. Use environment variables or CLI arguments instead.

## Configuration Options

### Enable/Disable

```bash
# Disable OpenSourceMalware checks
depgate scan -t npm -p package-name -a heur --osm-disable
```

### Custom Base URL

```bash
depgate scan -t npm -p package-name -a heur \
  --osm-base-url https://custom-api.example.com
```

### Cache TTL

```bash
depgate scan -t npm -p package-name -a heur \
  --osm-cache-ttl 7200  # Cache for 2 hours (default: 3600)
```

### Authentication Method

```bash
# Use header authentication (default)
depgate scan -t npm -p package-name -a heur --osm-auth-method header

# Use query parameter authentication
depgate scan -t npm -p package-name -a heur --osm-auth-method query
```

### Maximum Retries

```bash
depgate scan -t npm -p package-name -a heur --osm-max-retries 10
```

## Version-Specific Checks

The integration performs version-specific checks, which is critical for accurate detection. Only specific malicious versions are flagged, not entire packages.

### Examples

```bash
# Check specific vulnerable version (will be flagged)
depgate scan -t npm -p 'synckit:0.11.9' -a heur

# Check specific safe version (will not be flagged)
depgate scan -t npm -p 'synckit:0.11.11' -a heur

# Check latest version (uses resolved version, not package-level check)
depgate scan -t npm -p 'synckit' -a heur
```

**Important**: When no version is specified, the integration uses the resolved/latest version (not a package-level check that might incorrectly flag safe packages).

## Policy Integration

Use malware detection in policy rules:

```yaml
policy:
  rules:
    - type: malware
      fail_on_malicious: true
```

When a malicious package is detected:
- Heuristics analysis sets score to 0.0
- Policy rules can deny packages based on malware detection
- JSON output includes malware fields (see Output section)

## Output

When OpenSourceMalware integration is enabled, JSON output includes:

```json
{
  "packageName": "malicious-package",
  "osmMalicious": true,
  "osmReason": "Known malicious package",
  "osmThreatCount": 1,
  "osmSeverity": "high",
  "score": 0.0
}
```

**Fields:**
- `osmMalicious` - Boolean indicating if package is flagged as malicious
- `osmReason` - Reason for flagging (if malicious)
- `osmThreatCount` - Number of threats detected
- `osmSeverity` - Severity level (if malicious)

## YAML Configuration

Full YAML configuration example:

```yaml
opensourcemalware:
  enabled: true
  base_url: "https://api.opensourcemalware.com/functions/v1"
  api_token: ""  # Prefer environment variable
  cache_ttl_sec: 3600
  auth_method: "header"  # "header" or "query"
  max_retries: 5
  rate_limit_retry_delay_sec: 1.0
```

## Environment Variables

- `DEPGATE_OSM_ENABLED` - Enable/disable (true/false, 1/0, yes/no)
- `DEPGATE_OSM_API_TOKEN` - API token
- `DEPGATE_OSM_BASE_URL` - Override base URL
- `DEPGATE_OSM_CACHE_TTL_SEC` - Cache TTL in seconds
- `DEPGATE_OSM_AUTH_METHOD` - "header" or "query"
- `DEPGATE_OSM_MAX_RETRIES` - Maximum retries

## Rate Limiting

The integration includes built-in rate limit handling:

- Automatic retry with exponential backoff
- Respects `Retry-After` headers
- Configurable retry count and delays
- Per-service rate limit policies

Default rate limit policy for OpenSourceMalware API:
- Max retries: 5
- Initial backoff: 1.0 seconds
- Multiplier: 1.5
- Max backoff: 60.0 seconds

## Caching

Results are cached to minimize API calls:

- Default cache TTL: 3600 seconds (1 hour)
- Cache key: `(package_name, version, ecosystem)`
- Configurable via `--osm-cache-ttl` or YAML config

## Examples

### Basic Usage

```bash
# With environment variable
export DEPGATE_OSM_API_TOKEN=your_token
depgate scan -t npm -p left-pad -a heur -o results.json

# With CLI flag
depgate scan -t npm -p left-pad -a heur \
  --osm-api-token your_token -o results.json
```

### Scan Project with Malware Detection

```bash
export DEPGATE_OSM_API_TOKEN=your_token
depgate scan -t npm -d ./my-project -a heur -o results.json
```

### Policy with Malware Detection

```yaml
# policy.yml
policy:
  rules:
    - type: malware
      fail_on_malicious: true
```

```bash
export DEPGATE_OSM_API_TOKEN=your_token
depgate scan -t npm -d ./my-project -a policy -c policy.yml -o results.json
```

### Custom Configuration

```bash
depgate scan -t npm -p package-name -a heur \
  --osm-api-token your_token \
  --osm-cache-ttl 7200 \
  --osm-max-retries 10 \
  --osm-auth-method header
```

## Troubleshooting

### Integration Not Working

1. Verify API token is set correctly:
   ```bash
   echo $DEPGATE_OSM_API_TOKEN
   ```

2. Check if integration is enabled:
   ```bash
   depgate scan -t npm -p test -a heur --osm-disable  # Should not check
   ```

3. Enable debug logging:
   ```bash
   depgate scan -t npm -p test -a heur --loglevel DEBUG
   ```

### Rate Limit Issues

If you encounter rate limits:
- Increase `--osm-max-retries`
- Increase `--osm-cache-ttl` to cache longer
- Check API token limits with OpenSourceMalware

### False Positives

If a package is incorrectly flagged:
- Verify the specific version being checked
- Check OpenSourceMalware database directly
- Report false positives to OpenSourceMalware

## See Also

- [Configuration](configuration.md) - General configuration options
- [Policy Configuration](policy-configuration.md) - Using malware detection in policies
- [Output Formats](output-formats.md) - Understanding output schemas

[‚Üê Back to README](../README.md)
